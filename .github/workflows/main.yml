name: Manual Ngrok Setup

on:
  workflow_dispatch:
    inputs:
      port:
        description: 'Local port to expose'
        required: true
        default: 3000
        type: number

jobs:
  manual-ngrok:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Ngrok manually
      run: |
        # Download and install ngrok
        wget -q https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
        tar -xzf ngrok-v3-stable-linux-amd64.tgz
        sudo mv ngrok /usr/local/bin/
        ngrok --version

    - name: Configure Ngrok auth
      run: |
        ngrok authtoken ${{ secrets.NGROK_AUTH_TOKEN }}
        echo "âœ… Ngrok authenticated"

    - name: Create Python test server
      run: |
        cat > server.py << 'EOF'
from http.server import HTTPServer, BaseHTTPRequestHandler
import json
import datetime

class SimpleHandler(BaseHTTPRequestHandler):
    def do_GET(self):
        self.send_response(200)
        self.send_header('Content-type', 'text/html')
        self.end_headers()
        
        response = f"""
        <html>
            <body>
                <h1>ðŸš€ Server via Ngrok</h1>
                <p>Time: {datetime.datetime.now()}</p>
                <p>Path: {self.path}</p>
                <p>This server is exposed via Ngrok from GitHub Actions</p>
                <h3>Endpoints:</h3>
                <ul>
                    <li><a href="/health">/health</a></li>
                    <li><a href="/json">/json</a></li>
                </ul>
            </body>
        </html>
        """
        self.wfile.write(response.encode())
    
    def do_POST(self):
        content_length = int(self.headers['Content-Length'])
        post_data = self.rfile.read(content_length)
        
        self.send_response(200)
        self.send_header('Content-type', 'application/json')
        self.end_headers()
        
        response = {
            "status": "received",
            "data": post_data.decode(),
            "timestamp": str(datetime.datetime.now())
        }
        self.wfile.write(json.dumps(response).encode())

if __name__ == '__main__':
    port = 3000
    server = HTTPServer(('0.0.0.0', port), SimpleHandler)
    print(f"Starting server on port {port}...")
    server.serve_forever()
EOF

    - name: Start server in background
      run: |
        python server.py &
        echo "SERVER_PID=$!" >> $GITHUB_ENV
        sleep 3

    - name: Start Ngrok tunnel
      run: |
        ngrok http ${{ github.event.inputs.port }} --log=stdout > ngrok.log &
        echo "NGROK_PID=$!" >> $GITHUB_ENV
        sleep 10

    - name: Get tunnel URL
      id: tunnel
      run: |
        # Get tunnel URL from ngrok API
        max_retries=10
        for i in $(seq 1 $max_retries); do
          echo "Attempt $i to get tunnel URL..."
          TUNNEL_RESPONSE=$(curl -s http://localhost:4040/api/tunnels || true)
          TUNNEL_URL=$(echo "$TUNNEL_RESPONSE" | jq -r '.tunnels[0].public_url // empty')
          
          if [ -n "$TUNNEL_URL" ] && [ "$TUNNEL_URL" != "null" ]; then
            echo "âœ… Tunnel URL obtained: $TUNNEL_URL"
            echo "tunnel_url=$TUNNEL_URL" >> $GITHUB_OUTPUT
            echo "NGROK_URL=$TUNNEL_URL" >> $GITHUB_ENV
            break
          fi
          
          if [ $i -eq $max_retries ]; then
            echo "âŒ Failed to get tunnel URL after $max_retries attempts"
            echo "Ngrok log:"
            cat ngrok.log
            exit 1
          fi
          
          sleep 5
        done

    - name: Display connection info
      run: |
        echo "=========================================="
        echo "ðŸŒ YOUR NGROK TUNNEL IS ACTIVE"
        echo "=========================================="
        echo "Public URL: $NGROK_URL"
        echo "Local port: ${{ github.event.inputs.port }}"
        echo "Test URL: $NGROK_URL/health"
        echo "=========================================="
        
        # Show tunnel details
        echo "Tunnel details:"
        curl -s http://localhost:4040/api/tunnels | jq '.'

    - name: Test endpoints
      run: |
        echo "Testing endpoints via ngrok..."
        
        # Test GET request
        echo "GET $NGROK_URL/health"
        curl -s "$NGROK_URL/health" | head -5
        
        # Test POST request
        echo -e "\nPOST $NGROK_URL"
        curl -s -X POST "$NGROK_URL" \
          -H "Content-Type: application/json" \
          -d '{"test": "data"}' | jq '.'

    - name: Monitor tunnel
      run: |
        echo "ðŸ“¡ Tunnel monitoring active for 20 minutes..."
        echo "ðŸ”— Your URL: $NGROK_URL"
        echo "â° This workflow will timeout after 20 minutes of inactivity"
        
        # Simple keep-alive
        for i in {1..120}; do
          echo "[$(date +%H:%M:%S)] Tunnel active - $NGROK_URL"
          sleep 10
        done

    - name: Cleanup
      if: always()
      run: |
        echo "ðŸ§¹ Cleaning up processes..."
        pkill ngrok || true
        kill $SERVER_PID 2>/dev/null || true
        echo "âœ… Cleanup complete"
