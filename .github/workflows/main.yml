name: Webhook Testing

on:
  workflow_dispatch:

jobs:
  webhook-tester:
    runs-on: ubuntu-latest
    timeout-minutes: 25

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Ngrok
      uses: ngrok/setup-ngrok@v1
      with:
        auth-token: ${{ secrets.NGROK_AUTH_TOKEN }}

    - name: Create webhook receiver
      run: |
        cat > webhook_server.py << 'EOF'
from flask import Flask, request, jsonify
import json
from datetime import datetime

app = Flask(__name__)
webhooks = []

@app.route('/webhook', methods=['POST', 'GET'])
def webhook():
    if request.method == 'GET':
        return jsonify({
            "total_webhooks": len(webhooks),
            "webhooks": webhooks
        })
    
    # Handle POST request
    data = request.get_json(silent=True) or request.data.decode()
    headers = dict(request.headers)
    
    webhook_data = {
        "id": len(webhooks) + 1,
        "timestamp": datetime.now().isoformat(),
        "method": request.method,
        "headers": headers,
        "data": data,
        "remote_addr": request.remote_addr
    }
    
    webhooks.append(webhook_data)
    
    print(f"üì® Webhook #{len(webhooks)} received")
    
    return jsonify({"status": "success", "id": len(webhooks)})

@app.route('/')
def home():
    return '''
    <h1>Webhook Testing Server</h1>
    <p>Send webhooks to: <code>/webhook</code></p>
    <p>View received webhooks: <code>/webhook</code> (GET)</p>
    <p>Total received: ''' + str(len(webhooks)) + '''</p>
    '''

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000)
EOF

        pip install flask

    - name: Start server and tunnel
      run: |
        # Start webhook server
        python webhook_server.py &
        echo "SERVER_PID=$!" >> $GITHUB_ENV
        
        # Start ngrok tunnel
        ngrok http 5000 &
        echo "NGROK_PID=$!" >> $GITHUB_ENV
        
        sleep 10

    - name: Get webhook URL
      id: get_url
      run: |
        max_retries=5
        for i in $(seq 1 $max_retries); do
          URL=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url')
          if [ "$URL" != "null" ] && [ -n "$URL" ]; then
            echo "webhook_url=$URL/webhook" >> $GITHUB_OUTPUT
            echo "WEBHOOK_URL=$URL/webhook" >> $GITHUB_ENV
            echo "‚úÖ Webhook URL: $URL/webhook"
            break
          fi
          sleep 5
        done

    - name: Display webhook information
      run: |
        echo "üéØ WEBHOOK TESTING SERVER"
        echo "================================"
        echo "Webhook URL: $WEBHOOK_URL"
        echo "View received: $WEBHOOK_URL (GET)"
        echo "Test with: curl -X POST $WEBHOOK_URL -d '{\"test\":\"data\"}'"
        echo "================================"

    - name: Keep alive
      run: |
        echo "‚è∞ Webhook server active for 20 minutes..."
        echo "üì® Send webhooks to: $WEBHOOK_URL"
        
        for i in {1..120}; do
          echo "[$(date +%H:%M:%S)] Waiting for webhooks... ($i/120)"
          sleep 10
        done
