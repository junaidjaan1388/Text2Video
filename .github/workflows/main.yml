name: Ngrok Tunnel Setup

on:
  workflow_dispatch:
    inputs:
      port:
        description: 'Local port to expose'
        required: true
        default: 8080
        type: number
      protocol:
        description: 'Protocol to use'
        required: true
        default: 'http'
        type: choice
        options:
          - 'http'
          - 'tcp'
          - 'tls'

jobs:
  ngrok-tunnel:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Ngrok
      uses: actions-hub/ngrok@v3.0.0
      with:
        auth-token: ${{ secrets.NGROK_AUTH_TOKEN }}
        config: |
          version: "2"
          authtoken: ${{ secrets.NGROK_AUTH_TOKEN }}
          tunnels:
            my-app:
              addr: ${{ github.event.inputs.port }}
              proto: ${{ github.event.inputs.protocol }}
        start: false

    - name: Start Ngrok tunnel
      run: |
        ngrok start --all --config ngrok.yml &
        NGROK_PID=$!
        echo "NGROK_PID=$NGROK_PID" >> $GITHUB_ENV
        sleep 5

    - name: Get Ngrok public URL
      id: ngrok_url
      run: |
        # Get the public URL
        NGROK_URL=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url')
        echo "Public URL: $NGROK_URL"
        echo "ngrok_url=$NGROK_URL" >> $GITHUB_OUTPUT
        
        # Also set as environment variable
        echo "NGROK_PUBLIC_URL=$NGROK_URL" >> $GITHUB_ENV

    - name: Display tunnel information
      run: |
        echo "ğŸ¯ Ngrok Tunnel Active"
        echo "ğŸ“¡ Public URL: $NGROK_PUBLIC_URL"
        echo "ğŸ”Œ Local Port: ${{ github.event.inputs.port }}"
        echo "ğŸ“‹ Protocol: ${{ github.event.inputs.protocol }}"
        
        # Show tunnel status
        curl -s http://localhost:4040/api/tunnels | jq '.'

    - name: Keep tunnel alive
      run: |
        echo "ğŸ• Keeping tunnel active for 25 minutes..."
        for i in {1..150}; do
          echo "â° Tunnel active for $(($i/6)) minutes $(($i%6*10)) seconds"
          sleep 10
        done

    - name: Stop Ngrok tunnel
      if: always()
      run: |
        pkill ngrok || true
        echo "ğŸ›‘ Ngrok tunnel stopped"
