name: Ngrok Tunnel Setup

on:
  workflow_dispatch:
    inputs:
      port:
        description: 'Local port to expose'
        required: true
        default: 8080
        type: number

jobs:
  ngrok-tunnel:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Setup Ngrok with official action
      uses: ngrok/setup-ngrok@v1
      with:
        auth-token: ${{ secrets.NGROK_AUTH_TOKEN }}

    - name: Start Ngrok tunnel
      run: |
        ngrok http ${{ github.event.inputs.port }} --log=stdout > ngrok.log &
        echo "NGROK_PID=$!" >> $GITHUB_ENV
        sleep 5

    - name: Get Ngrok public URL
      id: ngrok_url
      run: |
        # Wait for tunnel to be ready
        sleep 5
        
        # Get the public URL from ngrok API
        NGROK_URL=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url')
        
        if [ "$NGROK_URL" = "null" ] || [ -z "$NGROK_URL" ]; then
          echo "âŒ Failed to get ngrok URL. Checking logs:"
          cat ngrok.log
          exit 1
        fi
        
        echo "Public URL: $NGROK_URL"
        echo "ngrok_url=$NGROK_URL" >> $GITHUB_OUTPUT
        echo "NGROK_PUBLIC_URL=$NGROK_URL" >> $GITHUB_ENV

    - name: Display tunnel information
      run: |
        echo "ğŸ¯ Ngrok Tunnel Active"
        echo "ğŸ“¡ Public URL: $NGROK_PUBLIC_URL"
        echo "ğŸ”Œ Local Port: ${{ github.event.inputs.port }}"
        echo "ğŸ“‹ Protocol: HTTP"
        
        # Show detailed tunnel info
        echo "ğŸ“Š Tunnel Details:"
        curl -s http://localhost:4040/api/tunnels | jq '.'

    - name: Start test server
      run: |
        # Start a simple HTTP server on the specified port
        python -m http.server ${{ github.event.inputs.port }} &
        echo "SERVER_PID=$!" >> $GITHUB_ENV
        sleep 2

    - name: Test the tunnel
      run: |
        echo "Testing tunnel connection..."
        if curl -f "$NGROK_PUBLIC_URL" > /dev/null 2>&1; then
          echo "âœ… Tunnel is working correctly!"
        else
          echo "âŒ Tunnel test failed"
          echo "Debug info:"
          curl -s http://localhost:4040/api/tunnels | jq '.'
        fi

    - name: Keep tunnel alive
      run: |
        echo "ğŸ• Keeping tunnel active for 25 minutes..."
        for i in {1..150}; do
          minutes=$((i/6))
          seconds=$((i%6*10))
          echo "â° Tunnel active for ${minutes}m ${seconds}s - URL: $NGROK_PUBLIC_URL"
          sleep 10
        done

    - name: Stop Ngrok tunnel
      if: always()
      run: |
        pkill ngrok || true
        kill $SERVER_PID 2>/dev/null || true
        echo "ğŸ›‘ Ngrok tunnel stopped"
