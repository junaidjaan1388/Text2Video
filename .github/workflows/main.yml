name: Ngrok Tunnel Setup

on:
  workflow_dispatch:
    inputs:
      port:
        description: 'Local port to expose'
        required: true
        default: 8080
        type: number
      timeout_minutes:
        description: 'How long to keep tunnel active (minutes)'
        required: false
        default: 30
        type: number

jobs:
  ngrok-tunnel:
    runs-on: ubuntu-latest
    timeout-minutes: ${{ github.event.inputs.timeout_minutes + 5 }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y jq curl python3

    - name: Install Ngrok
      run: |
        # Download and install ngrok
        wget -q -O ngrok.tgz https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
        tar -xzf ngrok.tgz
        chmod +x ngrok
        sudo mv ngrok /usr/local/bin/
        ngrok version

    - name: Setup Ngrok authentication
      run: |
        if [ -n "${{ secrets.NGROK_AUTH_TOKEN }}" ]; then
          ngrok authtoken "${{ secrets.NGROK_AUTH_TOKEN }}"
          echo "âœ… Ngrok authentication configured"
        else
          echo "âš ï¸  No NGROK_AUTH_TOKEN secret found - using free version (limited)"
        fi

    - name: Start test server
      run: |
        # Create a better test server with health endpoint
        cat > server.py << 'EOF'
from http.server import HTTPServer, BaseHTTPRequestHandler
import json
import time

class SimpleHandler(BaseHTTPRequestHandler):
    def do_GET(self):
        if self.path == '/health':
            self.send_response(200)
            self.send_header('Content-type', 'application/json')
            self.end_headers()
            response = {
                "status": "healthy",
                "timestamp": time.time(),
                "service": "Test Server"
            }
            self.wfile.write(json.dumps(response).encode())
        else:
            self.send_response(200)
            self.send_header('Content-type', 'text/html')
            self.end_headers()
            html = f"""
            <html>
                <head><title>Test Server</title></head>
                <body>
                    <h1>ğŸš€ Test Server Running!</h1>
                    <p><strong>Port:</strong> ${{ github.event.inputs.port }}</p>
                    <p><strong>Time:</strong> {time.ctime()}</p>
                    <p><strong>Health Check:</strong> <a href="/health">/health</a></p>
                </body>
            </html>
            """
            self.wfile.write(html.encode())
    
    def log_message(self, format, *args):
        print(f"[{self.client_address[0]}] {format % args}")

print(f"Starting test server on port ${{ github.event.inputs.port }}...")
server = HTTPServer(('0.0.0.0', ${{ github.event.inputs.port }}), SimpleHandler)
server.serve_forever()
EOF

        # Start the test server
        python3 server.py &
        echo "SERVER_PID=$!" >> $GITHUB_ENV
        sleep 3
        
        # Test local server
        if curl -s http://localhost:${{ github.event.inputs.port }}/health > /dev/null; then
          echo "âœ… Test server started successfully on port ${{ github.event.inputs.port }}"
        else
          echo "âŒ Failed to start test server"
          exit 1
        fi

    - name: Start Ngrok tunnel
      run: |
        echo "ğŸŒ Starting Ngrok tunnel..."
        
        # Start ngrok with more detailed logging
        ngrok http ${{ github.event.inputs.port }} --log=stdout --log-level=debug > ngrok.log 2>&1 &
        echo "NGROK_PID=$!" >> $GITHUB_ENV
        
        echo "âœ… Ngrok process started (PID: $!)"
        echo "Waiting for tunnel to initialize..."
        sleep 15

    - name: Get Ngrok public URL
      id: ngrok_url
      run: |
        echo "ğŸ”— Retrieving Ngrok public URL..."
        
        max_attempts=15
        for attempt in $(seq 1 $max_attempts); do
          echo "Attempt $attempt/$max_attempts..."
          
          # Method 1: Try ngrok API
          if curl -s http://localhost:4040/api/tunnels > /dev/null 2>&1; then
            NGROK_URL=$(curl -s http://localhost:4040/api/tunnels 2>/dev/null | jq -r '.tunnels[] | select(.proto == "https") | .public_url' | head -1)
            
            if [ -n "$NGROK_URL" ] && [ "$NGROK_URL" != "null" ]; then
              echo "âœ… Ngrok URL found via API: $NGROK_URL"
              echo "ngrok_url=$NGROK_URL" >> $GITHUB_OUTPUT
              echo "NGROK_PUBLIC_URL=$NGROK_URL" >> $GITHUB_ENV
              break
            fi
          fi
          
          # Method 2: Check logs
          if [ -f ngrok.log ]; then
            LOG_URL=$(grep -oE 'url=https://[a-zA-Z0-9.-]+\.ngrok(-free)?\.app' ngrok.log | head -1 | cut -d= -f2)
            if [ -n "$LOG_URL" ]; then
              echo "âœ… Ngrok URL found in logs: $LOG_URL"
              echo "ngrok_url=$LOG_URL" >> $GITHUB_OUTPUT
              echo "NGROK_PUBLIC_URL=$LOG_URL" >> $GITHUB_ENV
              break
            fi
          fi
          
          if [ $attempt -eq $max_attempts ]; then
            echo "âŒ Failed to get Ngrok URL after $max_attempts attempts"
            echo "Debug info:"
            echo "Ngrok process:"
            ps aux | grep ngrok || true
            echo "Ngrok logs:"
            tail -50 ngrok.log
            exit 1
          fi
          
          sleep 5
        done

    - name: Display tunnel information
      run: |
        echo ""
        echo "=========================================="
        echo "ğŸ¯ NGROK TUNNEL ACTIVE"
        echo "=========================================="
        echo "ğŸ“¡ Public URL: $NGROK_PUBLIC_URL"
        echo "ğŸ”Œ Local Port: ${{ github.event.inputs.port }}"
        echo "â±ï¸  Timeout: ${{ github.event.inputs.timeout_minutes }} minutes"
        echo "=========================================="
        echo ""
        echo "ğŸ“Š Quick Test:"
        echo "   Health: $NGROK_PUBLIC_URL/health"
        echo "   Main:   $NGROK_PUBLIC_URL"
        echo ""
        echo "ğŸ”§ Tunnel Details:"
        curl -s http://localhost:4040/api/tunnels 2>/dev/null | jq -r '.tunnels[] | "   \(.name): \(.public_url) -> \(.config.addr)"' || echo "   Cannot get tunnel details"

    - name: Test tunnel connection
      run: |
        echo "ğŸ§ª Testing tunnel connection..."
        
        if curl -f -s --retry 3 --retry-delay 2 "$NGROK_PUBLIC_URL/health" > /dev/null; then
          echo "âœ… Tunnel connection successful!"
          echo "Health check response:"
          curl -s "$NGROK_PUBLIC_URL/health" | jq '.' || curl -s "$NGROK_PUBLIC_URL/health"
        else
          echo "âš ï¸  Direct health check failed"
          echo "Trying main endpoint..."
          if curl -s "$NGROK_PUBLIC_URL" > /dev/null; then
            echo "âœ… Main endpoint is accessible"
          else
            echo "âŒ Tunnel test failed - check Ngrok configuration"
          fi
        fi

    - name: Keep tunnel alive with monitoring
      run: |
        TIMEOUT_MINUTES=${{ github.event.inputs.timeout_minutes }}
        echo "ğŸ• Keeping tunnel active for $TIMEOUT_MINUTES minutes..."
        echo "ğŸ”— Public URL: $NGROK_PUBLIC_URL"
        echo ""
        echo "ğŸ“ You can now:"
        echo "   1. Share this URL with others"
        echo "   2. Test your local service remotely"
        echo "   3. The tunnel will auto-close after $TIMEOUT_MINUTES minutes"
        echo ""
        
        # Calculate monitoring intervals
        TOTAL_INTERVALS=$((TIMEOUT_MINUTES * 6))  # Check every 10 seconds
        HEALTH_CHECK_INTERVAL=12  # Check health every 2 minutes
        
        for ((i=1; i<=TOTAL_INTERVALS; i++)); do
          minutes=$((i/6))
          seconds=$((i%6*10))
          echo "[$(date +'%H:%M:%S')] Active: ${minutes}m ${seconds}s | URL: $NGROK_PUBLIC_URL"
          
          # Health check every 2 minutes
          if [ $((i % HEALTH_CHECK_INTERVAL)) -eq 0 ]; then
            if curl -s "$NGROK_PUBLIC_URL/health" > /dev/null 2>&1; then
              echo "   âœ… Remote: Healthy | Local: Port ${{ github.event.inputs.port }}"
            else
              echo "   âš ï¸  Remote: Unreachable | Local: Checking..."
              # Check local server
              if curl -s http://localhost:${{ github.event.inputs.port }}/health > /dev/null 2>&1; then
                echo "   âŒ Remote tunnel issue (local server is healthy)"
              else
                echo "   ğŸ”´ Local server down"
              fi
            fi
          fi
          
          sleep 10
        done
        
        echo "â° Timeout reached - shutting down tunnel"

    - name: Upload logs for debugging
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ngrok-logs
        path: |
          ngrok.log
        retention-days: 1

    - name: Cleanup
      if: always()
      run: |
        echo "ğŸ§¹ Cleaning up processes..."
        # Kill ngrok process
        pkill -f "ngrok http" || true
        # Kill test server
        kill $SERVER_PID 2>/dev/null || true
        # Wait for processes to exit
        sleep 3
        echo "âœ… Cleanup complete"
        
        # Final status
        echo "ğŸ“Š Final status:"
        ps aux | grep -E "(ngrok|python3)" | grep -v grep || echo "No processes running"
