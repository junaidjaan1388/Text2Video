name: Ngrok Tunnel Setup

on:
  workflow_dispatch:
    inputs:
      port:
        description: 'Local port to expose'
        required: true
        default: 8080
        type: number

jobs:
  ngrok-tunnel:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Install Ngrok directly
      run: |
        # Download and install ngrok
        wget -q -O ngrok.tgz https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
        tar -xzf ngrok.tgz
        chmod +x ngrok
        sudo mv ngrok /usr/local/bin/
        ngrok version

    - name: Setup Ngrok authentication
      run: |
        ngrok authtoken "${{ secrets.NGROK_AUTH_TOKEN }}"
        echo "âœ… Ngrok authentication configured"

    - name: Start test server
      run: |
        # Start a simple HTTP server
        python -m http.server ${{ github.event.inputs.port }} &
        echo "SERVER_PID=$!" >> $GITHUB_ENV
        sleep 2
        echo "âœ… Test server started on port ${{ github.event.inputs.port }}"

    - name: Start Ngrok tunnel
      run: |
        # Start ngrok tunnel in background
        ngrok http ${{ github.event.inputs.port }} --log=stdout > ngrok.log 2>&1 &
        echo "NGROK_PID=$!" >> $GITHUB_ENV
        echo "âœ… Ngrok tunnel starting..."
        sleep 10

    - name: Get Ngrok public URL
      id: get_url
      run: |
        # Wait for tunnel to establish
        echo "Waiting for tunnel to be ready..."
        sleep 10
        
        # Try to get URL from ngrok API
        max_attempts=10
        for i in $(seq 1 $max_attempts); do
          echo "Attempt $i to get tunnel URL..."
          
          # Check if ngrok API is responding
          if curl -s http://localhost:4040/api/tunnels > /dev/null; then
            NGROK_URL=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url // empty')
            
            if [ -n "$NGROK_URL" ] && [ "$NGROK_URL" != "null" ]; then
              echo "âœ… Tunnel URL obtained: $NGROK_URL"
              echo "ngrok_url=$NGROK_URL" >> $GITHUB_OUTPUT
              echo "NGROK_PUBLIC_URL=$NGROK_URL" >> $GITHUB_ENV
              break
            fi
          fi
          
          if [ $i -eq $max_attempts ]; then
            echo "âŒ Failed to get tunnel URL after $max_attempts attempts"
            echo "Ngrok log contents:"
            cat ngrok.log
            echo "Trying alternative method..."
            
            # Alternative: Try to extract URL from logs
            LOG_URL=$(grep -o 'url=[^ ]*' ngrok.log | head -1 | cut -d= -f2 || true)
            if [ -n "$LOG_URL" ]; then
              echo "âœ… Found URL in logs: $LOG_URL"
              echo "ngrok_url=$LOG_URL" >> $GITHUB_OUTPUT
              echo "NGROK_PUBLIC_URL=$LOG_URL" >> $GITHUB_ENV
            else
              echo "âŒ No URL found in logs either"
              exit 1
            fi
          fi
          
          sleep 5
        done

    - name: Display tunnel information
      run: |
        echo "=========================================="
        echo "ðŸŽ¯ NGROK TUNNEL ACTIVE"
        echo "=========================================="
        echo "ðŸ“¡ Public URL: $NGROK_PUBLIC_URL"
        echo "ðŸ”Œ Local Port: ${{ github.event.inputs.port }}"
        echo "ðŸŒ Test URL: $NGROK_PUBLIC_URL"
        echo "=========================================="
        
        # Show tunnel details
        echo "ðŸ“Š Tunnel Details:"
        curl -s http://localhost:4040/api/tunnels 2>/dev/null | jq '.' || echo "Cannot get tunnel details"

    - name: Test tunnel connection
      run: |
        echo "Testing tunnel connection..."
        if curl -f -s "$NGROK_PUBLIC_URL" > /dev/null; then
          echo "âœ… Tunnel is working correctly!"
          echo "Server response:"
          curl -s "$NGROK_PUBLIC_URL" | head -5
        else
          echo "âš ï¸  Direct tunnel test failed, but tunnel might still be establishing"
          echo "Debug information:"
          ps aux | grep ngrok || true
          netstat -tlnp | grep 4040 || true
        fi

    - name: Keep tunnel alive with monitoring
      run: |
        echo "ðŸ• Keeping tunnel active for 25 minutes..."
        echo "ðŸ”— Your public URL: $NGROK_PUBLIC_URL"
        echo "ðŸ“ You can share this URL to access your local server"
        
        # Monitor tunnel status
        for i in {1..150}; do
          minutes=$((i/6))
          seconds=$((i%6*10))
          echo "[$(date +%H:%M:%S)] Tunnel active for ${minutes}m ${seconds}s"
          
          # Check tunnel status every 30 seconds
          if [ $((i % 3)) -eq 0 ]; then
            if curl -s http://localhost:4040/api/tunnels > /dev/null; then
              echo "âœ… Tunnel status: Healthy"
            else
              echo "âš ï¸  Tunnel status: Cannot reach ngrok API"
            fi
          fi
          
          sleep 10
        done

    - name: Cleanup
      if: always()
      run: |
        echo "ðŸ§¹ Cleaning up processes..."
        pkill -f ngrok || true
        kill $SERVER_PID 2>/dev/null || true
        echo "âœ… Cleanup complete"
