name: Text-to-Image Web App

on:
  workflow_dispatch:
    inputs:
      prompt:
        description: 'Default prompt for image generation'
        required: true
        default: 'A beautiful sunset over mountains, digital art'
      port:
        description: 'Web server port'
        required: true
        default: 5000
        type: number

jobs:
  text-to-image-app:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y wget

    - name: Install Python dependencies
      run: |
        cd web-app
        pip install -r requirements.txt

    - name: Install Ngrok
      run: |
        wget -q -O ngrok.tgz https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
        tar -xzf ngrok.tgz
        chmod +x ngrok
        sudo mv ngrok /usr/local/bin/
        ngrok version

    - name: Setup Ngrok authentication
      run: |
        ngrok authtoken "${{ secrets.NGROK_AUTH_TOKEN }}"
        echo "âœ… Ngrok authentication configured"

    - name: Create outputs directory
      run: mkdir -p web-app/outputs

    - name: Start Flask server
      run: |
        cd web-app
        python app.py &
        echo "SERVER_PID=$!" >> $GITHUB_ENV
        sleep 5
        echo "âœ… Flask server started"

    - name: Start Ngrok tunnel
      run: |
        ngrok http 5000 --log=stdout > ngrok.log 2>&1 &
        echo "NGROK_PID=$!" >> $GITHUB_ENV
        sleep 10

    - name: Get Ngrok public URL
      id: get_url
      run: |
        echo "Getting Ngrok public URL..."
        max_attempts=8
        for i in $(seq 1 $max_attempts); do
          if curl -s http://localhost:4040/api/tunnels > /dev/null 2>&1; then
            NGROK_URL=$(curl -s http://localhost:4040/api/tunnels | jq -r '.tunnels[0].public_url // empty' 2>/dev/null || echo "")
            if [ -n "$NGROK_URL" ] && [ "$NGROK_URL" != "null" ]; then
              echo "âœ… Ngrok URL: $NGROK_URL"
              echo "ngrok_url=$NGROK_URL" >> $GITHUB_OUTPUT
              echo "NGROK_PUBLIC_URL=$NGROK_URL" >> $GITHUB_ENV
              break
            fi
          fi
          sleep 3
        done

        if [ -z "$NGROK_PUBLIC_URL" ]; then
          echo "âš ï¸ Could not get Ngrok URL"
          echo "ngrok_url=https://placeholder.ngrok.io" >> $GITHUB_OUTPUT
        fi

    - name: Display connection information
      run: |
        echo ""
        echo "âœ¨ ========================================="
        echo "âœ¨   AI IMAGE GENERATOR READY!"
        echo "âœ¨ ========================================="
        echo "âœ¨ Web Interface: $NGROK_PUBLIC_URL"
        echo "âœ¨ Health Check: $NGROK_PUBLIC_URL/health"
        echo "âœ¨ Server Port: 5000"
        echo "âœ¨ ========================================="

    - name: Test the application
      run: |
        echo "Testing application..."
        sleep 3
        
        if curl -s http://localhost:5000/health > /dev/null; then
          echo "âœ… Health endpoint working"
        else
          echo "âŒ Health endpoint failed"
        fi

    - name: Keep service running
      run: |
        echo "ðŸ• AI Image Generator active for 25 minutes..."
        echo "ðŸŒ Your URL: $NGROK_PUBLIC_URL"
        
        for i in {1..150}; do
          minutes=$((i/6))
          seconds=$((i%6*10))
          echo "[$(date +%H:%M:%S)] Active: ${minutes}m ${seconds}s"
          sleep 10
        done

    - name: Upload generated images
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ai-images
        path: web-app/outputs/
        retention-days: 30
        if-no-files-found: warn

    - name: Cleanup
      if: always()
      run: |
        echo "ðŸ§¹ Cleaning up..."
        pkill -f "python app.py" 2>/dev/null || true
        pkill -f ngrok 2>/dev/null || true
        echo "âœ… Cleanup complete"
