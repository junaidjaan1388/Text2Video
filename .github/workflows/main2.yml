name: Cloudflared Tunnel

on:
  workflow_dispatch:
    inputs:
      port:
        description: 'Port to expose'
        required: true
        default: 8080
        type: number

jobs:
  cloudflared-tunnel:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install Cloudflared
      run: |
        wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64
        chmod +x cloudflared-linux-amd64
        sudo mv cloudflared-linux-amd64 /usr/local/bin/cloudflared

    - name: Start test server
      run: |
        python -m http.server ${{ github.event.inputs.port }} &
        echo "SERVER_PID=$!" >> $GITHUB_ENV

    - name: Start Cloudflared tunnel
      run: |
        cloudflared tunnel --url http://localhost:${{ github.event.inputs.port }} > tunnel.log 2>&1 &
        echo "TUNNEL_PID=$!" >> $GITHUB_ENV
        sleep 10
        
        # Cloudflared doesn't have a simple API to get URL, but it will show in logs
        echo "Check the workflow logs for your tunnel URL"

    - name: Keep alive
      run: |
        echo "ğŸš€ Cloudflared tunnel active for 20 minutes"
        echo "ğŸ“ Check logs above for your public URL"
        sleep 1200
