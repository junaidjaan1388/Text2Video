name: AI Image Generator

on:
  workflow_dispatch:
    inputs:
      prompt:
        description: 'Image prompt'
        required: true
        default: 'A beautiful sunset'

jobs:
  image-generator:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y libgl1 libglib2.0-0

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install flask pillow requests
        pip install torch torchvision --index-url https://download.pytorch.org/whl/cpu
        pip install diffusers accelerate transformers

    - name: Create project structure
      run: |
        mkdir -p web-app/outputs
        cd web-app

    - name: Create simplified Flask app
      run: |
        cat > app.py << 'EOF'
from flask import Flask, request, jsonify, send_file, render_template_string
import os
from datetime import datetime
import requests
import io
import base64

app = Flask(__name__)

# Simple HTML interface
HTML_TEMPLATE = '''
<!DOCTYPE html>
<html>
<head>
    <title>AI Image Generator</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .container { background: #f5f5f5; padding: 20px; border-radius: 10px; }
        input, textarea, button { width: 100%; padding: 10px; margin: 10px 0; }
        button { background: #007acc; color: white; border: none; cursor: pointer; }
        button:hover { background: #005a9e; }
        .image-result { margin-top: 20px; text-align: center; }
        img { max-width: 100%; border: 1px solid #ddd; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé® AI Image Generator</h1>
        <form id="generateForm">
            <textarea id="prompt" name="prompt" rows="3" placeholder="Describe the image you want to generate...">{{ default_prompt }}</textarea>
            <button type="submit">Generate Image</button>
        </form>
        <div id="result" class="image-result"></div>
    </div>

    <script>
        document.getElementById('generateForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const prompt = document.getElementById('prompt').value;
            const resultDiv = document.getElementById('result');
            
            resultDiv.innerHTML = '<p>‚è≥ Generating image... This may take 30-60 seconds.</p>';
            
            try {
                const response = await fetch('/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt: prompt })
                });
                
                if (response.ok) {
                    const blob = await response.blob();
                    const url = URL.createObjectURL(blob);
                    resultDiv.innerHTML = `
                        <p>‚úÖ Image generated successfully!</p>
                        <img src="${url}" alt="Generated image">
                        <p><a href="${url}" download="generated_image.png">Download Image</a></p>
                    `;
                } else {
                    const error = await response.json();
                    resultDiv.innerHTML = `<p style="color: red;">‚ùå Error: ${error.error}</p>`;
                }
            } catch (error) {
                resultDiv.innerHTML = `<p style="color: red;">‚ùå Network error: ${error.message}</p>`;
            }
        });
    </script>
</body>
</html>
'''

@app.route('/')
def home():
    default_prompt = "A beautiful sunset over mountains, digital art"
    return render_template_string(HTML_TEMPLATE, default_prompt=default_prompt)

@app.route('/health')
def health():
    return jsonify({"status": "healthy", "timestamp": datetime.now().isoformat()})

@app.route('/test')
def test():
    """Simple test endpoint"""
    return jsonify({"message": "Server is working!", "time": datetime.now().isoformat()})

@app.route('/generate', methods=['POST'])
def generate_image():
    try:
        data = request.get_json()
        prompt = data.get('prompt', 'A beautiful landscape')
        
        print(f"Received prompt: {prompt}")
        
        # For now, return a placeholder or use a simple image generation method
        # We'll use a placeholder and implement real AI generation separately
        
        from PIL import Image, ImageDraw, ImageFont
        import random
        
        # Create a simple placeholder image
        width, height = 512, 512
        image = Image.new('RGB', (width, height), color=(random.randint(0, 255), random.randint(0, 255), random.randint(0, 255)))
        draw = ImageDraw.Draw(image)
        
        # Add some text
        try:
            # Try to use a font
            font = ImageFont.load_default()
            text = f"Prompt: {prompt[:30]}..."
            bbox = draw.textbbox((0, 0), text, font=font)
            text_width = bbox[2] - bbox[0]
            text_height = bbox[3] - bbox[1]
            x = (width - text_width) // 2
            y = (height - text_height) // 2
            draw.text((x, y), text, fill=(255, 255, 255), font=font)
        except:
            # Fallback if font fails
            draw.text((10, 10), f"AI Image: {prompt}", fill=(255, 255, 255))
        
        # Save image
        timestamp = datetime.now().strftime("%Y%m%d_%H%M%S")
        filename = f"image_{timestamp}.png"
        filepath = os.path.join('outputs', filename)
        image.save(filepath)
        
        # Return image
        img_io = io.BytesIO()
        image.save(img_io, 'PNG')
        img_io.seek(0)
        
        return send_file(img_io, mimetype='image/png', as_attachment=True, download_name=filename)
        
    except Exception as e:
        print(f"Error: {e}")
        return jsonify({"error": str(e)}), 500

if __name__ == '__main__':
    print("üöÄ Starting AI Image Generator Server...")
    app.run(host='0.0.0.0', port=5000, debug=False)
EOF

    - name: Install Ngrok
      run: |
        wget -q -O ngrok.tgz https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
        tar -xzf ngrok.tgz
        chmod +x ngrok
        sudo mv ngrok /usr/local/bin/
        echo "‚úÖ Ngrok installed"

    - name: Setup Ngrok
      run: |
        ngrok authtoken "${{ secrets.NGROK_AUTH_TOKEN }}" || echo "‚ö†Ô∏è  Ngrok token not set, using free version"
        echo "‚úÖ Ngrok configured"

    - name: Start Flask server
      run: |
        cd web-app
        python app.py &
        echo "FLASK_PID=$!" >> $GITHUB_ENV
        sleep 5

    - name: Wait for server to start
      run: |
        echo "‚è≥ Waiting for server to start..."
        for i in {1..10}; do
          if curl -s http://localhost:5000/health > /dev/null; then
            echo "‚úÖ Server started successfully!"
            break
          fi
          echo "Attempt $i/10: Server not ready..."
          sleep 3
        done

    - name: Start Ngrok tunnel
      run: |
        echo "üåê Starting Ngrok tunnel..."
        ngrok http 5000 --log=stdout > ngrok.log 2>&1 &
        echo "NGROK_PID=$!" >> $GITHUB_ENV
        sleep 8

    - name: Get Ngrok URL
      id: ngrok_url
      run: |
        echo "üîó Getting Ngrok URL..."
        for i in {1..10}; do
          URL=$(curl -s http://localhost:4040/api/tunnels 2>/dev/null | grep -o 'https://[^"]*\.ngrok\.io' | head -1)
          if [ -n "$URL" ]; then
            echo "‚úÖ Ngrok URL found: $URL"
            echo "ngrok_url=$URL" >> $GITHUB_OUTPUT
            break
          fi
          echo "Attempt $i/10: Waiting for Ngrok URL..."
          sleep 3
        done
        
        if [ -z "$URL" ]; then
          echo "‚ùå Could not get Ngrok URL"
          echo "üìÑ Ngrok logs:"
          cat ngrok.log
          exit 1
        fi

    - name: Display info
      run: |
        echo ""
        echo "‚ú® ================================="
        echo "‚ú®   AI IMAGE GENERATOR READY!"
        echo "‚ú® ================================="
        echo "‚ú® URL: ${{ steps.ngrok_url.outputs.ngrok_url }}"
        echo "‚ú® Health: ${{ steps.ngrok_url.outputs.ngrok_url }}/health"
        echo "‚ú® Test: ${{ steps.ngrok_url.outputs.ngrok_url }}/test"
        echo "‚ú® ================================="
        echo ""

    - name: Test connection
      run: |
        echo "Testing connection..."
        curl -s "${{ steps.ngrok_url.outputs.ngrok_url }}/health" || echo "Health check failed"
        curl -s "${{ steps.ngrok_url.outputs.ngrok_url }}/test" || echo "Test endpoint failed"

    - name: Keep alive
      run: |
        echo "üïê Service will run for 25 minutes..."
        echo "üìä Monitoring..."
        
        for i in {1..150}; do
          minutes=$((i/6))
          echo "[$(date +%H:%M:%S)] Running: ${minutes}m"
          
          # Check health every 2 minutes
          if [ $((i % 12)) -eq 0 ]; then
            if curl -s "${{ steps.ngrok_url.outputs.ngrok_url }}/health" > /dev/null; then
              count=$(find web-app/outputs -name "*.png" 2>/dev/null | wc -l)
              echo "   ‚úÖ Service healthy | Images: $count"
            else
              echo "   ‚ùå Service down"
            fi
          fi
          sleep 10
        done

    - name: Upload results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: generated-images
        path: web-app/outputs/
        retention-days: 30
