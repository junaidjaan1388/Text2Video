name: AI Image Generator

on:
  workflow_dispatch:
    inputs:
      prompt:
        description: 'Image prompt'
        required: true
        default: 'A beautiful sunset'

jobs:
  image-generator:
    runs-on: ubuntu-latest
    timeout-minutes: 25
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'

    - name: Install Python dependencies
      run: |
        cd web-app
        pip install flask pillow

    - name: Install Ngrok
      run: |
        wget -q -O ngrok.tgz https://bin.equinox.io/c/bNyj1mQVY4c/ngrok-v3-stable-linux-amd64.tgz
        tar -xzf ngrok.tgz
        chmod +x ngrok
        sudo mv ngrok /usr/local/bin/
        ngrok version

    - name: Setup Ngrok authentication
      run: |
        ngrok authtoken "${{ secrets.NGROK_AUTH_TOKEN }}"
        echo "âœ… Ngrok configured"

    - name: Create outputs directory
      run: mkdir -p web-app/outputs

    - name: Start Flask server
      run: |
        cd web-app
        python app.py &
        SERVER_PID=$!
        echo "SERVER_PID=$SERVER_PID" >> $GITHUB_ENV
        
        # Wait for server to start
        echo "â³ Waiting for server..."
        for i in {1..30}; do
          if curl -s http://localhost:5000/health > /dev/null 2>&1; then
            echo "âœ… Server is healthy after $((i*2)) seconds"
            break
          fi
          if [ $i -eq 30 ]; then
            echo "âŒ Server failed to start"
            exit 1
          fi
          sleep 2
        done

    - name: Start Ngrok tunnel
      run: |
        echo "ðŸŒ Starting Ngrok tunnel..."
        # Start ngrok and keep it running
        ngrok http 5000 --log=stdout > ngrok.log 2>&1 &
        echo "NGROK_PID=$!" >> $GITHUB_ENV
        
        # Give ngrok more time to initialize
        echo "Waiting for Ngrok to initialize..."
        sleep 15

    - name: Get Ngrok public URL
      id: ngrok_url
      run: |
        echo "ðŸ”— Getting Ngrok URL..."
        
        # Multiple methods to get the URL
        max_attempts=12
        for i in $(seq 1 $max_attempts); do
          echo "Attempt $i to get Ngrok URL..."
          
          # Method 1: Try ngrok API
          if curl -s http://localhost:4040/api/tunnels > /dev/null 2>&1; then
            URL=$(curl -s http://localhost:4040/api/tunnels 2>/dev/null | grep -o 'https://[^"]*\.ngrok\.io' | head -1)
            if [ -n "$URL" ]; then
              echo "âœ… Ngrok URL found via API: $URL"
              echo "ngrok_url=$URL" >> $GITHUB_OUTPUT
              break
            fi
          fi
          
          # Method 2: Check ngrok logs
          if [ -f ngrok.log ]; then
            URL=$(grep -o 'url=https://[^ ]*\.ngrok\.io' ngrok.log | head -1 | cut -d= -f2)
            if [ -n "$URL" ]; then
              echo "âœ… Ngrok URL found in logs: $URL"
              echo "ngrok_url=$URL" >> $GITHUB_OUTPUT
              break
            fi
          fi
          
          # Method 3: Try different API endpoint
          URL=$(curl -s http://localhost:4040/api/tunnels 2>/dev/null | python3 -c "
import sys, json
try:
    data = json.load(sys.stdin)
    tunnels = data.get('tunnels', [])
    if tunnels:
        print(tunnels[0].get('public_url', ''))
except:
    pass
" || echo "")
          
          if [ -n "$URL" ] && [ "$URL" != "null" ]; then
            echo "âœ… Ngrok URL found via JSON: $URL"
            echo "ngrok_url=$URL" >> $GITHUB_OUTPUT
            break
          fi
          
          if [ $i -eq $max_attempts ]; then
            echo "âŒ Could not get Ngrok URL after $max_attempts attempts"
            echo "Ngrok logs:"
            cat ngrok.log
            # Create a placeholder URL to continue
            echo "ngrok_url=https://placeholder.ngrok.io" >> $GITHUB_OUTPUT
          fi
          
          sleep 5
        done

    - name: Display connection information
      run: |
        echo ""
        echo "âœ¨ ========================================="
        echo "âœ¨   AI IMAGE GENERATOR READY!"
        echo "âœ¨ ========================================="
        echo "âœ¨ Public URL: ${{ steps.ngrok_url.outputs.ngrok_url }}"
        echo "âœ¨ Health Check: ${{ steps.ngrok_url.outputs.ngrok_url }}/health"
        echo "âœ¨ Test Image: ${{ steps.ngrok_url.outputs.ngrok_url }}/test"
        echo "âœ¨ ========================================="
        echo ""
        echo "ðŸ“ How to use:"
        echo "   1. Open the URL above"
        echo "   2. Enter your prompt"
        echo "   3. Click 'Generate Image'"
        echo "   4. Wait for your image"
        echo "   5. Images are saved automatically"

    - name: Test public access
      run: |
        URL="${{ steps.ngrok_url.outputs.ngrok_url }}"
        if [ "$URL" != "https://placeholder.ngrok.io" ]; then
          echo "Testing public access to: $URL"
          if curl -s "$URL/health" > /dev/null 2>&1; then
            echo "âœ… Public access working!"
          else
            echo "âš ï¸  Cannot access via public URL (this might be normal during startup)"
          fi
        else
          echo "âš ï¸  Using placeholder URL - check Ngrok configuration"
        fi

    - name: Keep service running
      run: |
        echo "ðŸ• AI Image Generator active for 20 minutes..."
        echo "ðŸŒ Your public URL: ${{ steps.ngrok_url.outputs.ngrok_url }}"
        echo ""
        echo "ðŸ“Š Monitoring service status..."
        
        for i in {1..120}; do
          minutes=$((i/6))
          seconds=$((i%6*10))
          echo "[$(date +%H:%M:%S)] Active: ${minutes}m ${seconds}s"
          
          # Check server health every 2 minutes
          if [ $((i % 12)) -eq 0 ]; then
            if curl -s http://localhost:5000/health > /dev/null; then
              count=$(find web-app/outputs -name "*.png" 2>/dev/null | wc -l)
              echo "   âœ… Server healthy | Images: $count"
            else
              echo "   âŒ Server down"
            fi
          fi
          
          sleep 10
        done

    - name: Upload generated images
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: ai-images
        path: web-app/outputs/
        retention-days: 30
        if-no-files-found: warn

    - name: Cleanup
      if: always()
      run: |
        echo "ðŸ§¹ Cleaning up..."
        kill $SERVER_PID 2>/dev/null || true
        pkill -f ngrok 2>/dev/null || true
        sleep 2
        echo "âœ… Cleanup complete"
        
        # Show final stats
        echo "ðŸ“Š Final statistics:"
        find web-app/outputs -name "*.png" 2>/dev/null | wc -l | xargs echo "Total images generated:"
